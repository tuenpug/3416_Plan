<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3416 æˆ°ç•¥çµ‚ç«¯ | å¤§å¸‚åŒæ­¥ Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; -webkit-font-smoothing: antialiased; }
        .mono { font-family: 'SF Mono', 'JetBrains Mono', monospace; }
        .active-btn:active { transform: scale(0.96); transition: 0.1s; }
        input, select { -webkit-appearance: none; border: none; outline: none; border-radius: 12px; }
        .mode-active { border: 2px solid #0f172a !important; background: #0f172a !important; color: white !important; }
        .chart-wrapper { position: relative; height: 140px; width: 100%; }
        .sync-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 pb-12">

    <div class="bg-slate-900 text-white p-6 rounded-b-[3rem] shadow-2xl mb-4">
        <div class="flex justify-between items-center mb-2 text-[10px] font-bold opacity-40 tracking-widest uppercase">
            <span>Terminal v17 | 100è¬èµ·å§‹</span>
            <div class="flex items-center gap-2">
                <span id="syncStatus" class="text-emerald-400 sync-pulse">â— å¤§å¸‚åŒæ­¥ä¸­</span>
                <span id="lastSyncTime">--:--</span>
            </div>
        </div>
        <div class="flex items-baseline gap-3 mb-6">
            <h1 id="totalEquity" class="text-4xl font-black mono tracking-tighter">$1,000,000</h1>
            <span id="totalRoi" class="bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded text-xs font-bold">+0.0%</span>
        </div>
        <div class="grid grid-cols-2 gap-6 border-t border-white/10 pt-5">
            <div class="text-left">
                <p class="text-[10px] opacity-40 uppercase font-bold mb-1 text-emerald-300">æµå‹•ç¾é‡‘</p>
                <p id="cashBal" class="text-xl font-bold mono text-emerald-400">$1,000,000</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] opacity-40 uppercase font-bold mb-1 text-rose-300">é è¨ˆæœˆæ´¾æ¯</p>
                <p id="estMonthDiv" class="text-xl font-bold mono text-rose-400">$0</p>
            </div>
        </div>
    </div>

    <div class="mx-4 mb-4 grid grid-cols-1 gap-3">
        <div id="aiAdvisor" class="p-5 rounded-3xl bg-white border border-slate-200 shadow-sm">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <span class="flex h-2 w-2 rounded-full bg-indigo-500"></span>
                    <h3 class="text-[10px] font-black text-slate-400 uppercase">æˆ°ç•¥è©•ä¼°</h3>
                </div>
                <div id="yieldValue" class="text-lg font-black mono text-indigo-600">--%</div>
            </div>
            <p id="adviceSignal" class="text-lg font-bold text-slate-800 mb-1">æ­£åœ¨é€£æ¥äº¤æ˜“æ‰€...</p>
            <p id="adviceDesc" class="text-[10px] text-slate-400">ç³»çµ±æ­£åœ¨åŒæ­¥ 3416.HK çš„å¯¦æ™‚æˆäº¤åƒ¹åŠæ¯ç‡æ•¸æ“šã€‚</p>
        </div>

        <div class="bg-indigo-600 p-4 rounded-3xl text-white shadow-lg flex justify-between items-center">
            <div>
                <p class="text-[10px] font-bold opacity-60 uppercase">ä¸‹æ¬¡é è¨ˆé™¤æ·¨æ—¥</p>
                <p id="cdDays" class="text-xl font-black">ç¬¬ 15-18 è™Ÿ</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] font-bold opacity-60 uppercase">è·é›¢æœ¬æœˆæ”¶æ¯</p>
                <p id="countdown" class="text-xl font-black">ç´„ -- å¤©</p>
            </div>
        </div>
    </div>

    <div class="px-4 space-y-4">
        <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-200">
            <div class="flex items-center gap-6">
                <div class="w-1/2 chart-wrapper"><canvas id="allocChart"></canvas></div>
                <div class="w-1/2 space-y-2 text-[10px] font-bold">
                    <div class="flex justify-between text-blue-500"><span>é•·ç·š (40%)</span><span id="v1_label" class="mono">0%</span></div>
                    <div class="flex justify-between text-amber-500"><span>æ³¢å¹… (30%)</span><span id="v2_label" class="mono">0%</span></div>
                    <div class="flex justify-between text-rose-500"><span>æ’ˆåº• (30%)</span><span id="v3_label" class="mono">0%</span></div>
                    <div class="flex justify-between text-slate-400 border-t pt-1"><span>æŒè‚¡ç¸½å€¼</span><span id="totalHoldingLabel" class="mono">$0</span></div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-[2.5rem] p-6 shadow-xl border border-slate-200 space-y-4">
            <div class="grid grid-cols-2 gap-2">
                <button id="buyModeBtn" onclick="switchMode('BUY')" class="mode-active py-4 rounded-2xl font-black text-xs">è²·å…¥</button>
                <button id="sellModeBtn" onclick="switchMode('SELL')" class="bg-slate-100 text-slate-400 py-4 rounded-2xl font-black text-xs">æ²½å‡º</button>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div class="bg-slate-100 p-3 rounded-2xl">
                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">åŒæ­¥å¸‚åƒ¹</span>
                    <input type="number" id="price" value="10.60" step="0.01" oninput="updateUI()" class="bg-transparent font-black mono text-lg w-full">
                </div>
                <div class="bg-emerald-50 p-3 rounded-2xl">
                    <span class="text-[9px] font-bold text-emerald-600 uppercase tracking-tighter">æœ€æ–°æœˆæ¯</span>
                    <input type="number" id="divSetting" value="0.141" step="0.001" oninput="updateUI()" class="bg-transparent font-black mono text-emerald-700 text-lg w-full">
                </div>
            </div>

            <select id="bucket" onchange="updateUI()" class="w-full p-4 bg-slate-100 rounded-2xl font-bold text-sm text-slate-600">
                <option value="longTerm">é•·ç·šæ ¸å¿ƒ (æˆ°ç•¥ä»½é¡ 40%)</option>
                <option value="swing">æ³¢å¹…çŸ­ç·š (æˆ°ç•¥ä»½é¡ 30%)</option>
                <option value="bottom">ä½ä½æ’ˆåº• (æˆ°ç•¥ä»½é¡ 30%)</option>
            </select>

            <div class="grid grid-cols-2 gap-2">
                <div class="bg-slate-100 rounded-2xl p-2 relative border-2 border-slate-200">
                    <span class="text-[8px] font-bold text-slate-400 uppercase absolute top-2 left-2">äº¤æ˜“è‚¡æ•¸</span>
                    <input type="number" id="shares" value="1000" oninput="updateUI()" class="w-full pt-4 bg-transparent font-mono font-bold text-center">
                    <button onclick="setMax()" class="absolute bottom-1 right-1 bg-slate-900 text-white text-[7px] px-2 py-0.5 rounded font-bold">MAX</button>
                </div>
                <div class="bg-slate-900 rounded-2xl p-2 flex flex-col justify-center items-center">
                    <span class="text-[8px] font-bold text-white/30 uppercase absolute top-2 left-2">äº¤æ˜“ç¸½é¡</span>
                    <p id="estAmount" class="font-mono font-bold text-emerald-400 text-xs mt-1">$0</p>
                </div>
            </div>

            <button onclick="execute()" id="execBtn" class="active-btn w-full bg-slate-900 text-white font-black py-5 rounded-3xl shadow-2xl uppercase text-sm tracking-widest">ç¢ºèªä¸¦è¨˜éŒ„äº¤æ˜“</button>
            <button onclick="collectDiv()" class="active-btn w-full bg-emerald-500 text-white font-black py-4 rounded-3xl shadow-lg uppercase text-xs">ğŸ’° æœ¬æœˆè‚¡æ¯å…¥è³¬</button>
        </div>

        <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 overflow-hidden mb-12">
            <div class="px-8 py-5 bg-slate-50 border-b flex justify-between items-center text-[10px] font-black text-slate-400">
                <span>HISTORY LOG</span>
                <button onclick="resetData()" class="text-rose-400">é‡è¨­æ•¸æ“š</button>
            </div>
            <div id="logBody" class="divide-y divide-slate-50 text-[11px] max-h-60 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const RATIOS = { longTerm: 0.40, swing: 0.30, bottom: 0.30 };
        const NAMES = { longTerm: 'é•·ç·š', swing: 'æ³¢å¹…', bottom: 'æ’ˆåº•' };
        let currentMode = 'BUY';
        let allocChart = null;

        let state = JSON.parse(localStorage.getItem('3416_final_v17')) || {
            cash: 1000000,
            holding: { longTerm: 0, swing: 0, bottom: 0 },
            used: { longTerm: 0, swing: 0, bottom: 0 },
            logs: []
        };

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šå¤§å¸‚åŒæ­¥ ---
        async function syncMarket() {
            try {
                const res = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/3416.HK`);
                const data = await res.json();
                const quote = data.chart.result[0].meta;
                document.getElementById('price').value = quote.regularMarketPrice.toFixed(2);
                document.getElementById('lastSyncTime').innerText = new Date().toLocaleTimeString().slice(0,5);
                updateUI();
            } catch (e) { console.log("Sync Error"); }
        }

        function updateUI() {
            const p = parseFloat(document.getElementById('price').value) || 0;
            const div = parseFloat(document.getElementById('divSetting').value) || 0;
            const totalHoldVal = (state.holding.longTerm + state.holding.swing + state.holding.bottom) * p;
            const totalEq = state.cash + totalHoldVal;
            const yieldVal = p > 0 ? (div * 12 / p * 100) : 0;

            // AI è©•ä¼°é‚è¼¯
            const signal = document.getElementById('adviceSignal');
            const desc = document.getElementById('adviceDesc');
            document.getElementById('yieldValue').innerText = yieldVal.toFixed(1) + "%";

            if (yieldVal >= 16) {
                signal.innerText = "ğŸš€ æ¿€é€²æ“´å¼µ (å»ºè­°ç”¨ï¼šæ’ˆåº•)"; signal.className = "text-lg font-bold text-rose-600 mb-1";
                desc.innerText = "æ¯ç‡æ¥µå…·å¸å¼•åŠ›ã€‚å»ºè­°å‹•ç”¨æ’ˆåº•ä»½é¡ï¼Œé€™æ˜¯åœ¨å¤§å¸‚ä½ä½å»ºç«‹è¢«å‹•æ”¶å…¥çš„é»ƒé‡‘æ™‚æ©Ÿã€‚";
            } else if (yieldVal >= 14) {
                signal.innerText = "ğŸ“ˆ ç©©å¥å¢æŒ (å»ºè­°ç”¨ï¼šé•·ç·š)"; signal.className = "text-lg font-bold text-emerald-600 mb-1";
                desc.innerText = "é€²å…¥åƒ¹å€¼å€é–“ï¼Œå»ºè­°å„ªå…ˆè£œæ»¿é•·ç·šæ ¸å¿ƒå€‰ä½ï¼Œç©©å®šç²å–æ¯æœˆæ´¾æ¯ã€‚";
            } else {
                signal.innerText = "âš ï¸ æ³¢æ®µé˜²å®ˆ (å»ºè­°ç”¨ï¼šæ³¢å¹…)"; signal.className = "text-lg font-bold text-amber-600 mb-1";
                desc.innerText = "æ¯ç‡è™•æ–¼å¹³å‡ç·šä¹‹ä¸‹ï¼Œè‚¡åƒ¹å¯èƒ½çŸ­æœŸè¶…è²·ã€‚æ³¢å¹…ä»½é¡å¯è€ƒæ…®é€¢é«˜æ¸›æŒã€‚";
            }

            // æ›´æ–°çœ‹æ¿æ•¸æ“š
            document.getElementById('totalEquity').innerText = "$" + Math.round(totalEq).toLocaleString();
            document.getElementById('totalRoi').innerText = (((totalEq - 1000000) / 1000000) * 100).toFixed(1) + "%";
            document.getElementById('cashBal').innerText = "$" + Math.round(state.cash).toLocaleString();
            document.getElementById('estMonthDiv').innerText = "$" + Math.round((state.holding.longTerm + state.holding.swing + state.holding.bottom) * div).toLocaleString();
            document.getElementById('totalHoldingLabel').innerText = "$" + Math.round(totalHoldVal).toLocaleString();

            // æ›´æ–°é™¤æ·¨æ—¥æé†’ (ç°¡å–®é ä¼°)
            const today = new Date().getDate();
            const daysLeft = today <= 15 ? 15 - today : 30 - today + 15;
            document.getElementById('countdown').innerText = daysLeft + " å¤©";

            // æ›´æ–°æ¯”ä¾‹
            if (allocChart) {
                allocChart.data.datasets[0].data = [state.holding.longTerm*p, state.holding.swing*p, state.holding.bottom*p, state.cash];
                allocChart.update('none');
            }
            
            document.getElementById('v1_label').innerText = totalEq > 0 ? ((state.holding.longTerm*p/totalEq)*100).toFixed(0) + "%" : "0%";
            document.getElementById('v2_label').innerText = totalEq > 0 ? ((state.holding.swing*p/totalEq)*100).toFixed(0) + "%" : "0%";
            document.getElementById('v3_label').innerText = totalEq > 0 ? ((state.holding.bottom*p/totalEq)*100).toFixed(0) + "%" : "0%";

            const s = parseInt(document.getElementById('shares').value) || 0;
            document.getElementById('estAmount').innerText = "$" + Math.round(p * s).toLocaleString();

            localStorage.setItem('3416_final_v17', JSON.stringify(state));
            renderLogs();
        }

        // --- äº¤æ˜“åŸ·è¡Œ ---
        function execute() {
            const p = parseFloat(document.getElementById('price').value);
            const s = parseInt(document.getElementById('shares').value);
            const b = document.getElementById('bucket').value;
            const amt = p * s;
            if (s <= 0) return;

            if (currentMode === 'BUY') {
                if (state.cash < amt) return alert("ç¾é‡‘ä¸è¶³");
                state.cash -= amt; state.holding[b] += s; state.used[b] += amt;
                log(`è²·å…¥ ${s.toLocaleString()}è‚¡ (${NAMES[b]})`, -amt);
            } else {
                if (state.holding[b] < s) return alert("æŒå€‰ä¸è¶³");
                const avgCost = state.used[b] / state.holding[b];
                state.cash += amt; state.holding[b] -= s; state.used[b] = Math.max(0, state.used[b] - (avgCost * s));
                log(`æ²½å‡º ${s.toLocaleString()}è‚¡ (${NAMES[b]})`, amt);
            }
            updateUI();
        }

        function setMax() {
            const p = parseFloat(document.getElementById('price').value) || 0;
            const b = document.getElementById('bucket').value;
            const totalEq = state.cash + (state.holding.longTerm + state.holding.swing + state.holding.bottom) * p;
            if (currentMode === 'BUY') {
                const limit = totalEq * RATIOS[b];
                const canSpend = Math.min(Math.max(0, limit - state.used[b]), state.cash);
                document.getElementById('shares').value = Math.floor(canSpend / p);
            } else {
                document.getElementById('shares').value = state.holding[b];
            }
            updateUI();
        }

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('buyModeBtn').className = mode === 'BUY' ? "mode-active py-4 rounded-2xl font-black text-xs" : "bg-slate-100 text-slate-400 py-4 rounded-2xl font-black text-xs";
            document.getElementById('sellModeBtn').className = mode === 'SELL' ? "mode-active py-4 rounded-2xl font-black text-xs !bg-rose-600 !border-rose-600" : "bg-slate-100 text-slate-400 py-4 rounded-2xl font-black text-xs";
            updateUI();
        }

        function collectDiv() {
            const div = parseFloat(document.getElementById('divSetting').value);
            const totalS = state.holding.longTerm + state.holding.swing + state.holding.bottom;
            if (totalS <= 0) return;
            state.cash += (div * totalS);
            log(`æ”¶æ¯å…¥è³¬ (@$${div})`, div * totalS);
            updateUI();
        }

        function log(msg, amt) {
            state.logs.unshift({ date: new Date().toLocaleDateString(), msg, amt });
            if (state.logs.length > 30) state.logs.pop();
        }

        function renderLogs() {
            document.getElementById('logBody').innerHTML = state.logs.map(l => `
                <div class="p-4 flex justify-between items-center bg-white px-8 border-b border-slate-50">
                    <div class="flex flex-col"><span class="font-bold text-[9px] uppercase">${l.msg}</span><span class="text-[7px] text-slate-400 mono">${l.date}</span></div>
                    <span class="font-black mono text-[11px] ${l.amt>=0?'text-emerald-500':'text-slate-900'}">${l.amt>=0?'+':''}${Math.round(l.amt).toLocaleString()}</span>
                </div>
            `).join('');
        }

        function resetData() { if(confirm("ç¢ºå®šé‡è¨­ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

        window.onload = () => {
            const ctx = document.getElementById('allocChart').getContext('2d');
            allocChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['é•·ç·š','æ³¢å¹…','æ’ˆåº•','ç¾é‡‘'], datasets: [{ data: [0,0,0,100], backgroundColor: ['#3b82f6','#f59e0b','#f43f5e','#f1f5f9'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: { display: false } } }
            });
            syncMarket();
            setInterval(syncMarket, 60000); // æ¯åˆ†é˜åŒæ­¥ä¸€æ¬¡
        };
    </script>
</body>
</html>
